function clamp(t,i,e){return Math.min(e,Math.max(i,t))}function project(t,i,e){return(t-i)/(e-i)}class BasePosition{get x(){throw new Error("Not implemented in base class.")}get y(){throw new Error("Not implemented in base class.")}setTarget(t,i,e){throw new Error("Not implemented in base class.")}update(t){}}class InterpolatedPosition extends BasePosition{constructor(){super(),this._st=this._et=0,this._x=this._tx=this._sx=0,this._y=this._ty=this._sy=0}get x(){return this._x}get y(){return this._y}setTarget(t,i,e){this._st=i,this._et=i+e,this._sx=this._x,this._sy=this._y,this._tx=t.x,this._ty=t.y}update(t){const i=project(t,this._st,this._et);if(i<=1){const t=this._tx-this._sx,e=this._ty-this._sy;this._x=this._sx+i*t,this._y=this._sy+i*e}}}class WebAudioOldListenerPosition extends InterpolatedPosition{constructor(t){super(),this.listener=t,this.listener.setPosition(0,0,0),this.listener.setOrientation(0,0,-1,0,1,0)}update(t){super.update(t),this.listener.setPosition(this.x,0,this.y)}}class WebAudioNodePosition extends BasePosition{constructor(t){super(),this.node=t,this.node.positionX.setValueAtTime(0,0),this.node.positionY.setValueAtTime(0,0),this.node.positionZ.setValueAtTime(0,0)}get x(){return this.node.positionX.value}get y(){return this.node.positionZ.value}setTarget(t,i,e){const s=i+e;this.node.positionX.linearRampToValueAtTime(t.x,s),this.node.positionZ.linearRampToValueAtTime(t.y,s)}}class WebAudioNewListenerPosition extends WebAudioNodePosition{constructor(t){super(t),this.node.forwardX.setValueAtTime(0,0),this.node.forwardY.setValueAtTime(0,0),this.node.forwardZ.setValueAtTime(-1,0),this.node.upX.setValueAtTime(0,0),this.node.upY.setValueAtTime(1,0),this.node.upZ.setValueAtTime(0,0)}}class MockAudioContext{constructor(){this._t=Date.now()/1e3}get currentTime(){return Date.now()/1e3-this._t}}class BaseSpatializer extends EventTarget{constructor(t,i,e,s){super(),this.id=t,this.destination=i,this.audio=e,this.position=s,this.volume=1,this.pan=0}dispose(){this.audio.pause(),this.position=null,this.audio=null,this.destination=null,this.id=null}update(){this.position.update(this.destination.audioContext.currentTime);const t=this.destination.position.x,i=this.destination.position.y,e=this.position.x-t,s=this.position.y-i,o=Math.sqrt(e*e+s*s);this.volume=1-clamp(project(o,this.destination.minDistance,this.destination.maxDistance),0,1),this.pan=o>0?e/o:0}setTarget(t){this.position.setTarget(t,this.destination.audioContext.currentTime,this.destination.transitionTime)}}class VolumeOnlySpatializer extends BaseSpatializer{constructor(t,i,e){super(t,i,e,new InterpolatedPosition),this.audio.play(),Object.seal(this)}update(){super.update(),this.audio.volume=this.volume}}const audioActivityEvt=Object.assign(new Event("audioActivity",{id:null,isActive:!1})),activityCounterMin=0,activityCounterMax=60,activityCounterThresh=5;function frequencyToIndex(t,i,e){var s=i/2;return clamp(Math.round(t/s*e),0,e)}function analyserFrequencyAverage(t,i,e,s,o){const n=t.context.sampleRate,a=frequencyToIndex(e,n,o),r=frequencyToIndex(s,n,o),u=r-a;let h=0;for(let t=a;t<r;++t)h+=i[t];return 0===u?0:h/u}class BaseWebAudioSpatializer extends BaseSpatializer{constructor(t,i,e,s,o,n,a){super(t,i,e,s),this.audio.volume=0,this.bufferSize=o,this.buffer=new Float32Array(this.bufferSize),this.analyser=this.destination.audioContext.createAnalyser(),this.analyser.fftSize=2*this.bufferSize,this.analyser.smoothingTimeConstant=.2,this.inNode=n,this.outNode=a||n,this.outNode.connect(this.destination.audioContext.destination),this.inNode!==this.outNode&&this.inNode.connect(this.outNode),this.wasActive=!1,this.lastAudible=!0,this.activityCounter=0,this.stream=null,this.source=null}update(){if(super.update(),!this.source)try{this.stream||(this.stream=this.audio.mozCaptureStream?this.audio.mozCaptureStream():this.audio.captureStream()),this.stream.active&&(this.source=this.destination.audioContext.createMediaStreamSource(this.stream),this.source.connect(this.analyser),this.source.connect(this.inNode))}catch(t){console.warn("Source isn't available yet. Will retry in a moment. Reason: ",t)}if(this.source){this.analyser.getFloatFrequencyData(this.buffer);const t=1.1+analyserFrequencyAverage(this.analyser,this.buffer,85,255,this.bufferSize)/100;t>=.5&&this.activityCounter<60?this.activityCounter++:t<.5&&this.activityCounter>0&&this.activityCounter--;const i=this.activityCounter>5;this.wasActive!==i&&(this.wasActive=i,audioActivityEvt.id=this.id,audioActivityEvt.isActive=i,this.dispatchEvent(audioActivityEvt))}}dispose(){this.source&&(this.source.disconnect(this.analyser),this.source.disconnect(this.inNode)),this.outNode.disconnect(this.destination.audioContext.destination),this.inNode!==this.outNode&&this.inNode.disconnect(this.outNode),this.source=null,this.stream=null,this.outNode=null,this.inNode=null,this.analyser=null,this.buffer=null,super.dispose()}}class FullSpatializer extends BaseWebAudioSpatializer{constructor(t,i,e,s){const o=i.audioContext.createPanner();super(t,i,e,new WebAudioNodePosition(o),s,o),this.inNode.panningModel="HRTF",this.inNode.distanceModel="inverse",this.inNode.refDistance=i.minDistance,this.inNode.rolloffFactor=i.rolloff,this.inNode.coneInnerAngle=360,this.inNode.coneOuterAngle=0,this.inNode.coneOuterGain=0,this.wasMuted=!1,Object.seal(this)}update(){super.update(),this.inNode.refDistance!==this.destination.minDistance&&(this.inNode.refDistance=this.destination.minDistance),this.inNode.rolloffFactor!==this.destination.rolloff&&(this.inNode.rolloffFactor=this.destination.rolloff);const t=this.volume<=0;this.source&&t!==this.wasMuted&&(this.wasMuted=t,t?this.source.disconnect(this.inNode):this.source.connect(this.inNode))}}class StereoSpatializer extends BaseWebAudioSpatializer{constructor(t,i,e,s){super(t,i,e,new InterpolatedPosition,s,i.audioContext.createStereoPanner(),i.audioContext.createGain()),Object.seal(this)}update(){super.update(),this.inNode.pan.value=this.pan,this.outNode.gain.value=this.volume}}const contextDestroyingEvt=new Event("contextDestroying"),contextDestroyedEvt=new Event("contextDestroyed");let hasWebAudioAPI=window.hasOwnProperty("AudioListener"),hasFullSpatializer=hasWebAudioAPI&&window.hasOwnProperty("PannerNode"),isLatestWebAudioAPI=hasWebAudioAPI&&AudioListener.prototype.hasOwnProperty("positionX");class Destination extends EventTarget{constructor(){super(),this.minDistance=1,this.maxDistance=10,this.rolloff=1,this.transitionTime=.125,this.createContext()}createContext(){if(!this.audioContext)try{if(hasWebAudioAPI){this.audioContext=new AudioContext;try{isLatestWebAudioAPI&&(this.position=new WebAudioNewListenerPosition(this.audioContext.listener))}catch(t){isLatestWebAudioAPI=!1,console.warn("No AudioListener.positionX property!",t)}finally{isLatestWebAudioAPI||(this.position=new WebAudioOldListenerPosition(this.audioContext.listener))}}}catch(t){hasWebAudioAPI=!1,console.warn("No WebAudio API!",t)}finally{hasWebAudioAPI||(this.audioContext=new MockAudioContext,this.position=new InterpolatedPosition)}}setTarget(t){this.position.setTarget(t,this.audioContext.currentTime,this.transitionTime)}setAudioProperties(t){this.minDistance=t.minDistance,this.maxDistance=t.maxDistance,this.transitionTime=t.transitionTime,this.rolloff=t.rolloff}update(){this.position.update(this.audioContext.currentTime)}createSpatializer(t,i,e){try{if(hasWebAudioAPI)try{if(hasFullSpatializer)return new FullSpatializer(t,this,i,e)}catch(t){hasFullSpatializer=!1,console.warn("No 360 spatializer support",t)}finally{if(!hasFullSpatializer)return new StereoSpatializer(t,this,i,e)}}catch(t){hasWebAudioAPI=!1,this.audioContext&&(this.dispatchEvent(contextDestroyingEvt),this.audioContext.close(),this.audioContext=null,this.position=null,this.dispatchEvent(contextDestroyedEvt)),console.warn("No WebAudio API!",t)}finally{if(!hasWebAudioAPI)return new VolumeOnlySpatializer(t,this,i)}}}const BUFFER_SIZE=1024,audioActivityEvt$1=Object.assign(new Event("audioActivity",{id:null,isActive:!1}));class AudioManager extends EventTarget{constructor(){super(),this.onAudioActivity=t=>{audioActivityEvt$1.id=t.id,audioActivityEvt$1.isActive=t.isActive,this.dispatchEvent(audioActivityEvt$1)},this.sourceLookup=new Map,this.sourceList=[],this.destination=new Destination;const t=[];this.destination.addEventListener("contextDestroying",()=>{for(let i of this.sourceList)i.removeEventListener("audioActivity",this.onAudioActivity),t.push({id:i.id,x:i.position.x,y:i.position.y,audio:i.audio}),this.sourceLookup.delete(i.id),i.dispose();this.sourceList.splice(0)}),this.destination.addEventListener("contextDestroyed",()=>{this.destination.createContext();for(let i of t){this.createSource(i.id,i.audio).setTarget(i)}t.splice(0)}),this.updater=()=>{requestAnimationFrame(this.updater),this.destination.update();for(let t of this.sourceList)t.update()},requestAnimationFrame(this.updater)}getSource(t){if(!this.sourceLookup.has(t)){const i=`#participant_${t} audio`,e=document.querySelector(i);e&&this.createSource(t,e)}const i=this.sourceLookup.get(t);return i||console.warn("no audio for user "+t),i}createSource(t,i){const e=this.destination.createSpatializer(t,i,1024);return e.addEventListener("audioActivity",this.onAudioActivity),this.sourceList.push(e),this.sourceLookup.set(t,e),e}setUserPosition(t){const i=this.getSource(t.id);i&&i.setTarget(t)}setLocalPosition(t){this.destination.setTarget(t)}setAudioProperties(t){this.destination.setAudioProperties(t)}removeUser(t){if(this.sourceLookup.has(t.id)){const i=this.sourceLookup.get(t.id),e=this.sourceList.indexOf(i);e>-1&&this.sourceList.splice(e,1),i.dispose(),this.sourceLookup.delete(t.id)}}}const FRONT_END_SERVER="https://calla"+window.location.hostname.substring(window.location.hostname.indexOf('.')),APP_FINGERPRINT="Calla",manager=new AudioManager;let origin=null;function txJitsiHax(t,i){if(null!==origin){const e={hax:"Calla",command:t,value:i};window.parent.postMessage(JSON.stringify(e),origin)}}manager.addEventListener("audioActivity",t=>{txJitsiHax("audioActivity",{id:t.id,isActive:t.isActive})}),window.addEventListener("message",t=>{const i=t.origin.match(/^https?:\/\/localhost\b/);if(t.origin===FRONT_END_SERVER||i)try{const i=JSON.parse(t.data);"Calla"===i.hax&&manager[i.command]&&(manager[i.command](i.value),"setAudioProperties"===i.command&&(origin=i.value.origin,console.log(origin)))}catch(t){console.error(t)}});
